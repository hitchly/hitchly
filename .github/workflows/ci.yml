name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      latex: ${{ steps.filter.outputs.latex }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            code:
              - '**/*.{ts,tsx,js,jsx,json,md}'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
              - 'tsconfig.json'
            latex:
              - 'docs/**/*.tex'
              - 'refs/**/*.bib'

  # --- CODE JOBS ---
  # These will now ONLY run if code files changed

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm type-check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm lint

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm format:check || (echo "Run 'pnpm format' to fix." && exit 1)

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm build

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    env:
      DB_HOST: 127.0.0.1
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: hitchly_db
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: hitchly_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - name: Push DB Schema
        run: pnpm --filter api db:push
      - name: Test
        run: pnpm test

  # --- LATEX JOBS ---
  # These will now ONLY run if .tex files changed

  latex-lint:
    name: LaTeX Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.latex == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install ChkTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y chktex
      - name: Lint LaTeX files
        run: |
          SKIP_FILES="Common.tex Comments.tex"
          ERROR_FOUND=0
          find docs -name "*.tex" -type f | while read texfile; do
            filename=$(basename "$texfile")
            if echo "$SKIP_FILES" | grep -q "$filename"; then continue; fi
            if grep -q "\\documentclass" "$texfile"; then
              echo "Linting: $texfile"
              chktex -q -n24 -n13 -n8 "$texfile" || { echo "ERROR: ChkTeX found issues in $texfile"; ERROR_FOUND=1; }
            fi
          done
          if [ $ERROR_FOUND -eq 1 ]; then echo "One or more LaTeX files have linting errors"; exit 1; fi

  latex-format-check:
    name: LaTeX Format Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.latex == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install LaTeX and latexindent
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra perl
      - name: Check LaTeX formatting
        run: |
          SKIP_FILES="Common.tex Comments.tex"
          ERROR_FOUND=0
          find docs -name "*.tex" -type f | while read texfile; do
            filename=$(basename "$texfile")
            if echo "$SKIP_FILES" | grep -q "$filename"; then continue; fi
            if grep -q "\\documentclass" "$texfile"; then
              echo "Checking formatting: $texfile"
              TEMP_FILE=$(mktemp)
              latexindent -w -c "$texfile" -o "$TEMP_FILE" 2>/dev/null || true
              if ! diff -q -w "$texfile" "$TEMP_FILE" > /dev/null 2>&1; then
                echo "ERROR: $texfile is not properly formatted"
                echo "Run: latexindent -w $texfile"
                ERROR_FOUND=1
              fi
              rm -f "$TEMP_FILE"
            fi
          done
          if [ $ERROR_FOUND -eq 1 ]; then echo "One or more LaTeX files are not properly formatted"; exit 1; fi

  latex-compile:
    name: LaTeX Compilation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.latex == 'true'
    strategy:
      fail-fast: false
      matrix:
        directory:
          - Checklists
          - Design/SoftArchitecture
          - Design/SoftDetailedDes
          - DevelopmentPlan
          - HazardAnalysis
          - ProblemStatementAndGoals
          - ReflectAndTrace
          - SRS
          - UserGuide
          - VnVPlan
          - VnVReport
          - projMngmnt
    steps:
      - uses: actions/checkout@v4
      - name: Install LaTeX packages
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-bibtex-extra texlive-science
      - name: Compile LaTeX in ${{ matrix.directory }}
        working-directory: docs/${{ matrix.directory }}
        run: |
          SKIP_FILES="Common.tex Comments.tex"
          find . -maxdepth 1 -name "*.tex" -type f | while read texfile; do
            filename=$(basename "$texfile")
            if echo "$SKIP_FILES" | grep -q "$filename"; then echo "Skipping include file: $filename"; continue; fi
            if grep -q "\\documentclass" "$texfile"; then
              echo "Compiling: $filename"
              if grep -qE '\\bibliography\{|\\bibliographystyle\{' "$texfile"; then
                echo "  Running full compilation with bibtex"
                pdflatex -interaction=nonstopmode "$filename" || { echo "ERROR: pass 1 failed"; exit 1; }
                if [ -f "${filename%.tex}.aux" ] && grep -qE '\\citation\{' "${filename%.tex}.aux" 2>/dev/null; then
                  bibtex "${filename%.tex}" 2>&1 | grep -v "I found no" || { echo "ERROR: bibtex failed"; exit 1; }
                fi
                pdflatex -interaction=nonstopmode "$filename" || { echo "ERROR: pass 2 failed"; exit 1; }
                pdflatex -interaction=nonstopmode "$filename" || { echo "ERROR: pass 3 failed"; exit 1; }
              else
                echo "  Running simple compilation"
                pdflatex -interaction=nonstopmode "$filename" || { echo "ERROR: pass 1 failed"; exit 1; }
                pdflatex -interaction=nonstopmode "$filename" || { echo "ERROR: pass 2 failed"; exit 1; }
              fi
            fi
          done
      - name: Check for LaTeX overflow warnings
        working-directory: docs/${{ matrix.directory }}
        run: |
          MAX_OVERFLOW_PT=300
          OVERFLOW_FOUND=0
          for logfile in $(find . -maxdepth 1 -name "*.log" -type f); do
            filename=$(basename "$logfile" .log)
            echo "Checking overflow warnings in: $logfile"
            OVERFLOWS=$(grep -E "Overfull \\\\hbox" "$logfile" || true)
            if [ -n "$OVERFLOWS" ]; then
              echo "Found overflow warnings in $filename.log:"
              echo "$OVERFLOWS" | head -20
              # Extract overflow amounts and check if any exceed threshold
              # Use awk to parse the overflow amount and compare
              EXCEEDING=$(echo "$OVERFLOWS" | grep -oE "[0-9]+\\.[0-9]+pt too wide" | sed 's/pt too wide//' | awk -v max="$MAX_OVERFLOW_PT" '$1+0 > max' || true)
              if [ -n "$EXCEEDING" ]; then
                echo "::error file=$logfile::Found overflow(s) exceeding ${MAX_OVERFLOW_PT}pt threshold:"
                echo "$EXCEEDING" | while read amount; do
                  echo "  - ${amount}pt overflow detected"
                done
                OVERFLOW_FOUND=1
              else
                OVERFLOW_COUNT=$(echo "$OVERFLOWS" | wc -l)
                echo "  Found $OVERFLOW_COUNT overflow(s), all within acceptable threshold (<= ${MAX_OVERFLOW_PT}pt)"
              fi
            else
              echo "  No overflow warnings found"
            fi
          done
          if [ $OVERFLOW_FOUND -eq 1 ]; then
            echo "::error::LaTeX overflow warnings exceed ${MAX_OVERFLOW_PT}pt threshold. Please fix margin issues."
            exit 1
          fi
          echo "✅ All overflow warnings are within acceptable limits"

  latex-compile-check:
    name: LaTeX Compilation Check
    runs-on: ubuntu-latest
    needs: [detect-changes, latex-compile]
    if: (needs.detect-changes.outputs.latex == 'true') && always()
    steps:
      - name: Check LaTeX compilation status
        run: |
          if [ "${{ needs.latex-compile.result }}" != "success" ]; then
            echo "One or more LaTeX directories failed to compile"
            exit 1
          fi

  ci:
    name: CI
    runs-on: ubuntu-latest
    if: always()
    needs:
      [
        type-check,
        lint,
        format-check,
        build,
        test,
        latex-lint,
        latex-format-check,
        latex-compile-check,
      ]
    steps:
      - name: Check Status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "❌ One or more jobs failed."
            exit 1
          fi
          echo "✅ All checks passed."
