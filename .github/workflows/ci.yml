name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

jobs:
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm type-check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check formatting
        run: pnpm format:check || (echo "Code is not formatted. Run 'pnpm format' to fix." && exit 1)

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

  latex-compile:
    name: LaTeX Compilation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install LaTeX packages
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-bibtex-extra

      - name: Compile LaTeX documents
        working-directory: docs
        run: |
          # Files to skip (include files, not standalone documents)
          SKIP_FILES="Common.tex Comments.tex"
          
          # Find all .tex files and compile standalone documents
          find . -name "*.tex" -type f | while read texfile; do
            filename=$(basename "$texfile")
            
            # Skip include files
            if echo "$SKIP_FILES" | grep -q "$filename"; then
              echo "Skipping include file: $texfile"
              continue
            fi
            
            # Check if file has \documentclass (standalone document)
            if grep -q "\\documentclass" "$texfile"; then
              echo "Compiling document: $texfile"
              dir=$(dirname "$texfile")
              cd "$dir"
              
              # Check if file has bibliography commands (must be in the actual file, not just hyperref)
              if grep -qE '\\bibliography\{|\\bibliographystyle\{' "$texfile"; then
                echo "  Document has bibliography, running full compilation with bibtex"
                # First pass to generate .aux file
                pdflatex -interaction=nonstopmode "$filename" || exit 1
                # Run bibtex ONLY if .aux file exists AND has actual citations
                if [ -f "${filename%.tex}.aux" ] && grep -qE '\\citation\{' "${filename%.tex}.aux" 2>/dev/null; then
                  echo "    Running bibtex (citations found)"
                  bibtex "${filename%.tex}" 2>&1 | grep -v "I found no" || true
                else
                  echo "    Skipping bibtex (no citations found)"
                fi
                # Run pdflatex again for references and bibliography
                pdflatex -interaction=nonstopmode "$filename" || exit 1
                pdflatex -interaction=nonstopmode "$filename" || exit 1
              else
                echo "  Document has no bibliography, running simple compilation"
                # Simple compilation without bibtex (2 passes for cross-references)
                pdflatex -interaction=nonstopmode "$filename" || exit 1
                pdflatex -interaction=nonstopmode "$filename" || exit 1
              fi
              cd - > /dev/null
            else
              echo "Skipping include file (no \\documentclass): $texfile"
            fi
          done

