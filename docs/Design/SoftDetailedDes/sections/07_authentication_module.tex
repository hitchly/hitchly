\section{Authentication \& Verification Module}

\subsection{Module}
The Authentication \& Verification Module manages user identity creation, secure login, and McMaster email verification for all Hitchly users.
This module is implemented using the \textbf{BetterAuth} authentication framework, which provides end-to-end session management, credential validation, and token-based verification. 
It ensures that only users with verified \texttt{@mcmaster.ca} emails can access the system's features.

\paragraph{Frontend}
The frontend component is integrated into the Expo mobile application.  
It provides the UI flow for login, signup, and verification.  
User input is collected through secure forms and sent to the backend via tRPC.  
The frontend handles the following:
\begin{itemize}
    \item Displays login and signup screens.
    \item Manages form validation and field state.
    \item Invokes BetterAuth client hooks for authentication (e.g., \texttt{useSignIn}, \texttt{useSignUp}).
    \item Handles redirect and session persistence after successful login.
    \item Presents error messages for invalid credentials or unverified accounts.
\end{itemize}

\paragraph{Backend}
The backend is implemented in the Express/tRPC API using \textbf{BetterAuth's server SDK}.  
It manages credential validation, session tokens, McMaster domain enforcement, and email verification logic.
Key backend operations include:
\begin{itemize}
    \item Configuring BetterAuth provider for the Hitchly API.
    \item Enforcing allowed email domains (\texttt{@mcmaster.ca}) during registration.
    \item Generating and validating secure verification tokens.
    \item Managing persistent user sessions through signed cookies and JWTs.
    \item Integrating with the email service for verification links.
\end{itemize}

\paragraph{Data}
The data layer persists authentication and verification information within the PostgreSQL database managed by Drizzle ORM.
BetterAuth automatically provisions and maintains required tables:
\begin{itemize}
    \item \texttt{users} --- stores user credentials, roles, and verification state.
    \item \texttt{sessions} --- stores active user sessions with expiry timestamps.
    \item \texttt{verification\_tokens} --- tracks issued and redeemed email verification tokens.
\end{itemize}
Data integrity is enforced by unique constraints on email and by transactional updates during verification.

\subsection{Uses}
This module ensures secure access to Hitchly by verifying each user's McMaster University affiliation.  
It interacts directly with:
\begin{itemize}
    \item \textbf{Frontend UI:} collects credentials and displays verification flows.
    \item \textbf{API Layer:} provides endpoints for signup, login, logout, and verification.
    \item \textbf{Database:} persists user and session data managed through BetterAuth.
\end{itemize}
All other modules depend on this component to validate user identity before allowing access to trip creation, matching, and messaging features.

\subsection{Syntax}

\paragraph{Exported Constants}
\begin{itemize}
    \item \texttt{ALLOWED\_DOMAIN = "@mcmaster.ca"}  
    Restricts signup to McMaster-affiliated emails.
    \item \texttt{SESSION\_EXPIRY = 24h}  
    Sets the maximum lifetime for user sessions.
\end{itemize}

\paragraph{Exported Access Programs}
\par\vspace{0.5em}

\begin{center}
\resizebox{\textwidth}{!}{
\begin{tabular}{l l l l}
\toprule
\textbf{Name} & \textbf{In} & \textbf{Out} & \textbf{Exceptions} \\
\midrule
\texttt{registerUser()} & name, email, password & verificationToken & DuplicateEmailError \\
\texttt{loginUser()} & email, password & sessionToken & InvalidCredentialsError \\
\texttt{verifyEmail()} & verificationToken & successFlag & ExpiredTokenError \\
\texttt{logoutUser()} & sessionToken & confirmation & InvalidSessionError \\
\bottomrule
\end{tabular}
}
\end{center}

\subsection{Semantics}

\paragraph{State Variables}
\begin{itemize}
    \item \texttt{isVerified: bool} --- indicates whether the user's email has been confirmed.
    \item \texttt{authToken: string} --- stores the active session token generated by BetterAuth.
    \item \texttt{sessionState: object} --- holds session metadata for frontend persistence.
\end{itemize}

\paragraph{Environment Variables}
\begin{itemize}
    \item User device input (keyboard, network, mobile UI).
    \item Secure HTTPS connection to API.
    \item Email server or transactional service for verification emails.
\end{itemize}

\paragraph{Assumptions}
\begin{itemize}
    \item All users have valid McMaster email accounts.
    \item Database migrations and BetterAuth setup scripts have been executed.
    \item Network connectivity is stable during registration or verification.
\end{itemize}

\paragraph{Access Routine Semantics}

\texttt{registerUser()}:
\begin{itemize}
    \item \textbf{transition:} Inserts a new pending user into the database and triggers a verification email.
    \item \textbf{output:} Returns a token or link for verification.
    \item \textbf{exception:} Thrown if email already exists or invalid domain detected.
\end{itemize}

\texttt{loginUser()}:
\begin{itemize}
    \item \textbf{transition:} Validates credentials and creates a session.
    \item \textbf{output:} Returns a signed JWT or session cookie.
    \item \textbf{exception:} InvalidCredentialsError if authentication fails.
\end{itemize}

\texttt{verifyEmail()}:
\begin{itemize}
    \item \textbf{transition:} Updates user's \texttt{isVerified} state to true.
    \item \textbf{output:} Returns success confirmation.
    \item \textbf{exception:} ExpiredTokenError if verification link invalid or expired.
\end{itemize}

\texttt{logoutUser()}:
\begin{itemize}
    \item \textbf{transition:} Revokes session in \texttt{sessions} table.
    \item \textbf{output:} Confirmation of logout.
    \item \textbf{exception:} InvalidSessionError if session token not found.
\end{itemize}

\paragraph{Local Functions}
\begin{itemize}
    \item \texttt{generateVerificationToken(): string} --- Creates a cryptographically secure token.
    \item \texttt{validateEmailDomain(email: string): boolean} --- Ensures domain ends with \texttt{@mcmaster.ca}.
    \item \texttt{hashPassword(password: string): string} --- Applies secure hashing for stored credentials.
\end{itemize}